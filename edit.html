<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
	<title>Map edit page</title>

	<link rel="stylesheet" href="map.css" />


</head>
<body style="display: none;" onkeydown="overideKeys(event)">
	<div id="nav">
		<div id="farleft">
			<h5 id="navtime">Last save {units} {unit} ago</h5>
			<h2 id="navname">A test name</h2>
		</div>
		<div id="tools">
			<button class="navtool" id="tool_select">Select</button>
			<button class="navtool" id="tool_line">Line</button>
			<button class="navtool" id="tool_rect">Rectange</button>
			
		</div>
		<div id="settingsC">
			<button id="settingsBtn">
				<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
				  <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
				  <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
				</svg>
			</button>
			<br>
			<button id="saveSvg" onclick="dumpSvgFile();">.SVG</button>
		</div>
		<div id="save">
			<button id="savebtn" tabindex="1" onclick="savebtn();">
				<!-- https://icons.getbootstrap.com/icons/save/ -->
				<svg xmlns="http://www.w3.org/2000/svg"  fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
				  <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1z"/>
				</svg>
			</button><br>
			<button id="exportbtn" onclick="exportbtn();">.MAP</button>
		</div>
	</div> <!-- end of navbar -->



	<div id="boardCont">
		<svg xmlns="http://www.w3.org/2000/svg" id="board" fill="currentColor">
			<rect id="screenBox" width="1" height="1" style="fill: none; stroke-width:1;stroke:rgb(0,0,0)" />
		</svg>
	</div>

	<div id="sidebarCont" class="active">
		<div id="sidebar">
			<h2 id="sideBarTitle">Example modal title:</h2>
			<table id="sidebarInfo">
				
			</table>
		</div>
		<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrow-left-circle" viewBox="0 0 16 16" onclick="toggleSidebar()">
			<circle cx="8" cy="8" r="8" style="fill: white" />
			  <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"/>
		</svg>
	</div>

	<div id="modalBackdrop">
		<div id="modalBody">
			<h1 id="modalTitle">Example modal title:</h1>
			<table id="modalInputs">
				
			</table>

		</div>	 
			<button id="modalBack">Back</button>
			<button id="modalSave">Confirm</button>
	</div>

	<script type="text/javascript">
		function capitalizeFirstLetter(string) {
		  return string.charAt(0).toUpperCase() + string.slice(1);
		}
		function formatTimeAgo(seconds) {
		// If you open this for more than a year without saving... good for you
		  const intervals = {
		    year: 60*60*24*365,
		    month: 60*60*24*30,
		    day: 60*60*24,
		    hour: 60*60,
		    minute: 60,
		    second: 1
		  };

		  for (let unit in intervals) {
		    const value = Math.floor(seconds / intervals[unit]);
		    if (value >= 1) {
		      return `${value} ${unit}${value === 1 ? '' : 's'} ago`;
		    }
		  }

		  return 'just now';
		}

		function downloadBlobFromString(content, fileName, mimeType) {
		  const blob = new Blob([content], { type: mimeType });

		  const link = document.createElement('a');
		  link.href = window.URL.createObjectURL(blob);
		  link.download = fileName;

		  document.body.appendChild(link);
		  link.click();

		  document.body.removeChild(link);
		  window.URL.revokeObjectURL(link.href);
		}
	</script>
	<script type="text/javascript" src="map.js"></script>
	<script type="text/javascript" src="tools/linetool.js"></script>
	<script type="text/javascript" src="tools.js"></script>
	<script type="text/javascript">
		var map, mapName;
		var saved, savedText;

		var zoomWidth = 200
		var zoomHeight = 200
		var zoomX = 0
		var zoomY = 0

		var svgWidth = 300;
		var svgHeight = 300;

		var showScreenBox = true;

		var activeToolbarItem = 0;

		var svgRatio = 10; // Pixels per 'foot''
		function do404(){
			document.body.innerHTML = "<center><h1>404 map not found</h1></center>";
		}
		// Don't do anything if 404
		(function(){
			if (!location.search.includes("?")) return do404();
			let nameGet = decodeURIComponent(location.search).split("name=");
			if (nameGet.length != 2) return do404();
			map = JSON.parse(localStorage.getItem(mapName = nameGet[1].toLowerCase()));
			if (!map || !mapName) return do404();
			document.querySelector("#navname").textContent = capitalizeFirstLetter(mapName);
			document.querySelector("#navtime").textContent = "";

			if (map.length == 0){
				map.push({
					type: "setsize",
					width: 100,
					height: 100,
					svgRatio: 10,
					showScreenBox: true
				});
				savebtn();
			}

			for (let obj of map){
				if (obj.type == "setsize"){
					svgWidth = obj.width;
					svgRatio = obj.svgRatio;
					svgHeight = obj.height;
					showScreenBox = obj.showScreenBox;
					zoomWidth=svgWidth*1.1;
					zoomHeight=zoomWidth;
					zoomX=-svgWidth*0.05
					zoomY=zoomX
					updateSvgSize();
				}
			}
			updateActiveTool();


		})();	
		function updateSvgSize(){
			let sb = document.querySelector("#screenBox");
			sb.setAttribute("width", svgWidth);
			sb.setAttribute("height", svgHeight);
			sb.style.display=showScreenBox ? "" : "none";
			
			updateSvgZoom();
		}
		function updateSvgZoom(){
			let svg = document.querySelector("#board");
			toolZoomHandle[activeToolbarItem]();
			
			svg.setAttribute("x", zoomX);
			svg.setAttribute("y", zoomY);
			svg.setAttribute("width", zoomWidth);
			svg.setAttribute("height", zoomHeight);
			svg.setAttribute("viewBox", zoomX+' '+zoomY+" "+zoomWidth+" "+zoomHeight)

			
		}
		function savebtn(){
			saved=Date.now();
			localStorage.setItem(mapName, JSON.stringify(map));
			updateSvgSize();
		}
		function exportbtn(){
			downloadBlobFromString(JSON.stringify([mapName, map]), mapName+".map", "text/plain")
		}
		function dumpSvgFile(){
			let screenBoxCpy = document.querySelector("#screenBox").cloneNode(true);
			document.querySelector("#screenBox").remove();

			let oldBox = document.querySelector("#board").getAttribute("viewBox");
			document.querySelector("#board").setAttribute("viewBox", "0 0 "+svgWidth+" "+svgHeight)
			let data = document.querySelector("#board").outerHTML;
			document.querySelector("#board").appendChild(screenBoxCpy);
			document.querySelector("#board").setAttribute("viewBox", oldBox);

			downloadBlobFromString(data, mapName+".svg", "image/svg+xml")
			
		}

		setInterval(function(){
			if (!saved) return;
							// Unix time in millisecounds
			let distance = Date.now() - saved; 
			let text = formatTimeAgo(distance/1000)
			if (text == savedText) return;

			savedText=text;
			document.querySelector("#navtime").textContent="Last saved "+text;
		}, 1000);
		document.body.style.display="";
	</script>
</body>
</html>